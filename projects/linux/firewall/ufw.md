#linux #firewall #ufw
#### Настройка UFW (несложный брандмауэр):
##### Установка: 
```bash
sudo apt-get install ufw
```
**Удаление UFW**
Вы можете удалить пакет ufw с вашего сервера Debian, выполнив следующую команду:
```bash
sudo apt autoremove ufw --purge -y
```
##### Отключение **IPv6** правил
Файл /etc/default/ufw — это файл конфигурации высокого уровня, предназначенный для изменения политик по умолчанию, добавления поддержки IPv6 и модулей ядра.
```bash
$ vi /etc/default/ufw
```
Отредактируйте раздел в файле, измените переменную IPV6 на yesy/no.
```
IPV6=yes
```
> Как сказано в описании, брандмауэр необходимо отключить, а затем включить, чтобы он вступил в силу.

#### Начальная настройка
По умолчанию UFW настройки запрещают все входящие соединения и разрешают все исходящие. Это значит, что если кто-то попытается  достичь ваш сервер, он не сможет подключиться, в то время как любое приложение на сервере имеет доступ к внешним соединениям.  
  
Cоответствующие правила фаервола прописываются так:
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
```
##### Добавление правила для SSH-соединений
 Чтобы разрешить входящие SSH-соединения, выполните команду:
```
sudo ufw allow ssh
```
SSH демон прослушивает 22 порт. UFW знает об именах распространенных служб (ssh, sftp, http, https), поэтому вы можете использовать их вместо номера порта.

Если ваш SSH-демон использует другой порт, вам необходимо указать его в явном виде, например:
```
sudo ufw allow 2222
```
Теперь, когда ваш межсетевой экран настроен, можете включать его.
##### Запуск UFW
Чтобы включить UFW, используйте следующую команду:
```
sudo ufw enable
```
Вы получите похожее  предупреждение:
```
Command may disrupt existing ssh connections. Proceed with operation (y|n)? 
```
Это означает, что запуск этого сервиса может разорвать текущее ssh соединение.  
Но, так как мы его уже добавили ssh в правила, этого не произойдет. Поэтому просто нажмите (y).
##### Добавление правил для других подключений
Чтобы ваши приложения работали корректно, вам необходимо добавить другие правила. Ниже будут  показаны настроить для наиболее распространённых служб.
###### HTTP (80 порт)
Для работы не зашифрованных веб-серверов используйте следующую команду:
```
sudo ufw allow http
```
или:
```
sudo ufw allow 80
```
###### HTTPS (443 порт)
То же самое, что и в предыдущем примере, но для зашифрованных соединений:
```
sudo ufw allow https
```
или:
```
sudo ufw allow 443
```
###### FTP (21 порт)
Данный порт используется для незашифрованной передачи файлов:
```
sudo ufw allow ftp
```
или:
```
sudo ufw allow 21/tcp
```
##### Добавление диапазонов портов
```
sudo ufw allow 3000:3100
```
Также вы можете указывать конкретный протокол:
```
sudo ufw allow 3000:3100/tcp
sudo ufw allow 3000:3100/udp
```
##### Добавление IP-адресов
Вs можете указать IP-адрес,  которому будет разрешен доступ.
```
sudo ufw allow from 123.45.67.89
```
В приведенном примере указанному адресу разрешается доступ ко всем портам сервера.

Если же вы хотите указать доступ к конкретному порту, воспользуйтесь командой вида:
```
sudo ufw allow from 123.45.67.89 to any port 22
```
Аналогичным образом вы можете работать с диапазонами IP-адресов:
```
sudo ufw allow from 123.45.67.89/24
sudo ufw allow from 123.45.67.89/24 to any port 22
```
##### Ограничение подключений
Чтобы запретить HTTP-соединения, вы можете использовать следующую команду:
```
sudo ufw deny http
```
Если вы хотите запретить все соединения с 123.45.67.89, воспользуйтесь следующей командой:
```
sudo ufw deny from 123.45.67.89
```
##### Ограничение скорости: 
Чтобы предотвратить атаки грубой силы, используйте ограничение скорости на SSH.:
```
sudo ufw limit ssh
```
если стандартный порт сменен то нужно указать его вместо имени службы/сервиса
```
sudo ufw limit 62226
```
##### Удаление правил
Существует два способа удаления правил. Первый — по номеру правила. Выполните команду:
```
sudo ufw status numbered
```
Вывод:
```
Status: active
     To                         Action      From
     --                         ------      ----
[ 1] 22                         ALLOW IN    Anywhere
[ 2] 80                         ALLOW IN    Anywhere
[ 3] 22 (v6)                    ALLOW IN    Anywhere (v6)
[ 4] 80 (v6)                    ALLOW IN    Anywhere (v6)
```
После этого выполните команду ufw delete и укажите номер правила, которое следует удалить:
```
sudo ufw delete 2
```
Второй способ заключается в том, что после команды ufw delete используется фактическое правило, например:
```
sudo ufw delete allow http
```
или:
```
sudo ufw delete allow 80
```
##### Отключение UFW
Отключить UFW можно при помощи команды:
```
sudo ufw disable
```
В результате ее выполнения все созданные ранее правила утратят силу.
##### Сброс правил
Если вам требуется сбросить текущие настройки, воспользуйтесь командой:
```
sudo ufw reset
```
В результате ее выполнения все правила будут отключены и удалены.
#### Логи
В Ufw есть опция сохранения логов — журнал событий. Для запуска, используйте команду:
```
sudo ufw logging on
```
Ufw поддерживает нескоько уровней логгирования:
- **off** — отключен.
- **low** — регистрирует все заблокированные пакеты, не соответствующие заданной политике (с ограничением скорости), а также пакеты, соответствующие зарегистрированным правилам.
- **medium** — все то, что при значении **low.** Плюс все разрешенные пакеты, не соответствующие заданной политике, все недопустимые пакеты, и все новые соединения. Все записи ведутся с ограничением скорости.
- **high** — работает также как и **medium.** Плюс все пакеты с ограничением скорости.
- **full** — также как и **high,** но без ограниения скорости. 

Чтобы задать уровень, укажите его как параметр:
```
 sudo ufw logging high
```
По умолчанию используется уровень **low.**
Для просмотра файлов относящихся с логам ufw используйте команду:
```
ls /var/log/ufw*
```
#### Источники:
1. [selectel.ru](https://selectel.ru/blog/tutorials/how-to-configure-firewall-with-ufw-on-ubuntu-20/)