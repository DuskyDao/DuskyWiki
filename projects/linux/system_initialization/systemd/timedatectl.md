#linux #systemd #time #date
### Просмотр времени
Для проверки текущего времени системных часов (представленных как в местном времени, так и в UTC), а также RTC (аппаратных часов):
```bash
$ timedatectl
```
#### Изменение времени системых часов
Установка местного времени для системых часов:
```bash
timedatectl set-time "гггг-ММ-дд чч:мм:сс"
```
Например:
```bash
timedatectl set-time "2014-05-26 11:13:54"
```
Установит 26 мая 2014 года, 11 часов 13 минут 54 секунды.
### Стандарт времени
Есть два основных стандарта времени: местное (локальное) время (localtime) и [Всемирное координированное время](https://en.wikipedia.org/wiki/ru:%D0%92%D1%81%D0%B5%D0%BC%D0%B8%D1%80%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BE%D1%80%D0%B4%D0%B8%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D0%B5_%D0%B2%D1%80%D0%B5%D0%BC%D1%8F "wikipedia:ru:Всемирное координированное время") (Coordinated Universal Time, UTC). Местное время зависит от текущего часового пояса, а время UTC — это глобальное время, которое одинаково для всех и не зависит от часовых поясов. UTC иногда называют [гринвичским временем](https://en.wikipedia.org/wiki/ru:%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D0%B5%D0%B5_%D0%B2%D1%80%D0%B5%D0%BC%D1%8F_%D0%BF%D0%BE_%D0%93%D1%80%D0%B8%D0%BD%D0%B2%D0%B8%D1%87%D1%83 "wikipedia:ru:Среднее время по Гринвичу") (GMT), хотя это немного разные вещи.

Стандарт, который будет использоваться в аппаратных часах, выбирается операционной системой. По умолчанию Windows использует местное время, macOS использует UTC, а другие UNIX и UNIX-подобные системы используют разные стандарты. ОС, использующая стандарт UTC, обычно рассматривает аппаратные часы как UTC и вносит в них поправку для установки времени ОС при загрузке в соответствии с часовым поясом.

Если на машине установлено несколько операционных систем, все они будут получать текущее время от одних и тех же аппаратных часов: рекомендуется настроить их на использование UTC, чтобы избежать конфликтов. В противном случае, если аппаратные часы установлены на местное время, сразу несколько операционных систем могут попытаться скорректировать его, например, после перехода на летнее/зимнее время, что приведёт к избыточной коррекции; проблемы могут также возникнуть при перемещении между различными часовыми поясами и использовании одной из операционных систем для сброса системных/аппаратных часов.

Значение аппаратных часов можно прочитать и изменить с помощью команды `timedatectl`. Вы можете узнать текущий стандарт, который Arch использует для работы с аппаратными часами, с помощью следующей команды:
```bash
$ timedatectl | grep local
```
RTC in local TZ: no
Переход на использование местного времени для аппаратных часов:
```bash
# timedatectl set-local-rtc **1**
```
Переход на использование UTC для аппаратных часов:
```bash
# timedatectl set-local-rtc **0**
```
Эти команды автоматически обновят аппаратные часы и файл `/etc/adjtime`, дополнительные действия не требуются.
Во время запуска ядра, в момент загрузки драйвера RTC, значение системных часов может быть установлено по аппаратным часам. Произойдет ли это, зависит от аппаратной платформы, версии ядра и опций сборки ядра. Если это происходит, то в этот момент последовательности загрузки время аппаратных часов принимается за UTC и значение `/sys/class/rtc/rtc_N_/hctosys` (N=0,1,2,..) будет установлено в 1.

Позже systemd снова обновляет системное время по аппаратным часам, опираясь на значения в `/etc/adjtime`. Следовательно, использование аппаратных часов с местным временем может привести к неожиданному поведению во время загрузки, например, системные часы могут перескочить назад по времени, что всегда является плохой идеей ([это ещё не всё](https://www.cl.cam.ac.uk/~mgk25/mswish/ut-rtc.html)). Чтобы избежать этого, systemd будет [синхронизироваться назад](https://lists.archlinux.org/archives/list/arch-dev-public@lists.archlinux.org/message/YUGQ47YQVRL6J2BO3D5G7LQM42H6RCCE/), только если аппаратные часы установлены в UTC, и не будет информировать ядро о локальном часовом поясе. Как следствие, временные метки на файловой системе FAT, которые изменены через Linux, будут в UTC.

**Примечание:**
- Использование `timedatectl` требует активной шины [D-Bus](https://wiki.archlinux.org/title/D-Bus_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "D-Bus (Русский)"). Поэтому использование этой команды под [chroot](https://wiki.archlinux.org/title/Chroot_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Chroot (Русский)") (например, во время установки) может оказаться невозможным. В таких случаях можно вернуться к команде hwclock или использовать [systemd-nspawn](https://wiki.archlinux.org/title/Systemd-nspawn_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Systemd-nspawn (Русский)") вместо chroot.
- Если файл `/etc/adjtime` отсутствует, systemd по умолчанию считает, что аппаратные часы используют UTC.
#### UTC в Microsoft Windows
При [двойной загрузке с Windows](https://wiki.archlinux.org/title/Dual_boot_with_Windows_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Dual boot with Windows (Русский)") рекомендуется настроить Windows на использование UTC, а не настраивать Linux на использование местного времени. (По умолчанию Windows использует местное время [[1]](https://devblogs.microsoft.com/oldnewthing/20040902-00/?p=37983).)

Это делается простым изменением в реестре: откройте `regedit` и добавьте `DWORD` ключ со значением `1` здесь:
```
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TimeZoneInformation\RealTimeIsUniversal
```
Это можно сделать одной командой в командной строке, запущенной от имени администратора:
```powershell
reg add "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\TimeZoneInformation" /v RealTimeIsUniversal /d 1 /t REG_DWORD /f
```
Также можно создать `*.reg` файл и импортировать его в реестр двойным щелчком мыши:

Windows Registry Editor Version 5.00
```
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TimeZoneInformation]
"RealTimeIsUniversal"=dword:00000001
```
Если Windows попросит обновить часы в связи с изменениями DST, позвольте ей это сделать. Часы останутся в UTC, как и ожидалось, скорректируется только отображаемое время.

После этого Аппаратные часы и Системные часы может понадобиться обновить.

Если у вас проблемы со смещением времени, попробуйте переустановить [tzdata](https://archlinux.org/packages/?name=tzdata) и заново установить часовой пояс:
```bash
timedatectl set-timezone Europe/Moscow
```
### Часовой пояс
Узнать текущий часовой пояс, установленный в системе:
```
$ timedatectl status
```

Просмотр списка доступных часовых поясов:
```
$ timedatectl list-timezones
```
Изменение часового пояса:
```
# timedatectl set-timezone _Регион_/_Город_
```
Например:
```
# timedatectl set-timezone Europe/Moscow
```
Эта команда создаст символическую ссылку `/etc/localtime`, которая ведёт на соответствующий файл с информацией о зоне в `/usr/share/zoneinfo/`. Если вам нужно создать её вручную (например, внутри [chroot](https://wiki.archlinux.org/title/Chroot_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9) "Chroot (Русский)"), где `timedatectl` не работает), имейте в виду, что это должна быть именно символическая ссылка:
```
# ln -sf /usr/share/zoneinfo/_Регион_/_Город_ /etc/localtime
```
> **Совет:** Можно найти и выбрать нужный часовой пояс с помощью интерактивного помощника _tzselect_.

Смотрите [timedatectl(1)](https://man.archlinux.org/man/timedatectl.1) и [localtime(5)](https://man.archlinux.org/man/localtime.5) для более подробной информации.
### NTP syns
Проверяем статус синхронизации
![](files/Pasted%20image%2020240821165348.png)
если **NTP service: inactive**, то включаем
```bash
timedatectl set-ntp true
```
Для примера будем использовать сервер с адресом `192.168.5.1`. 
Редактируем  `/etc/systemd/timesyncd.conf` для синхронизации времени с NTP-сервером с IP-адресом `192.168.5.1`:
```bash
# Раскомментируем
[Time]
NTP=192.168.5.1
FallbackNTP=
```
Перезапускаем службу синхронизации времени
```bash
systemctl restart systemd-timesyncd.service
```
Проверить статус службы
```bash
systemctl status systemd-timesyncd.service
```